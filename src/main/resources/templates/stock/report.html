<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>재고 리포트</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container mt-5">
  <h1 class="mb-4">재고 리포트</h1>

  <form th:action="@{/stock-report/generate}" method="get" class="mb-4">
    <div class="form-row">
      <div class="col">
        <label for="startDate">시작일:</label>
        <input type="date" id="startDate" name="startDate" class="form-control" required>
      </div>
      <div class="col">
        <label for="endDate">종료일:</label>
        <input type="date" id="endDate" name="endDate" class="form-control" required>
      </div>
      <div class="col">
        <label for="itemId">품목 ID (선택사항):</label>
        <input type="number" id="itemId" name="itemId" class="form-control">
      </div>
      <div class="col align-self-end">
        <button type="submit" class="btn btn-primary">리포트 생성</button>
      </div>
    </div>
  </form>

  <div th:if="${reportData}">
    <h2>리포트 결과</h2>
    <p>조회 기간: <span th:text="${#dates.format(startDate, 'yyyy-MM-dd')}"></span> ~ <span th:text="${#dates.format(endDate, 'yyyy-MM-dd')}"></span></p>
    <p>총 재고 가치: <span th:text="${#numbers.formatDecimal(totalValue, 0, 'COMMA', 2, 'POINT')}"></span> 원</p>

    <div class="mb-4">
      <canvas id="stockChart"></canvas>
    </div>

    <table class="table table-striped">
      <thead>
      <tr>
        <th>날짜</th>
        <th>품목명</th>
        <th>수량</th>
        <th>위치</th>
        <th>단가</th>
        <th>총 가치</th>
        <th>상세</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="item : ${reportData}">
        <td th:text="${#dates.format(item.date, 'yyyy-MM-dd')}"></td>
        <td th:text="${item.itemName}"></td>
        <td th:text="${item.totalQty}"></td>
        <td th:text="${item.location}"></td>
        <td th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 2, 'POINT')}"></td>
        <td th:text="${#numbers.formatDecimal(item.totalValue, 0, 'COMMA', 2, 'POINT')}"></td>
        <td>
          <a th:href="@{/stock-report/detail/{stkId}(stkId=${item.stk_id})}" class="btn btn-sm btn-info">상세</a>
        </td>
      </tr>
      </tbody>
    </table>

    <div class="mt-3">
      <a th:href="@{/stock-report/export/excel(startDate=${startDate},endDate=${endDate},itemId=${itemId})}" class="btn btn-success">Excel 다운로드</a>
      <a th:href="@{/stock-report/export/pdf(startDate=${startDate},endDate=${endDate},itemId=${itemId})}" class="btn btn-danger">PDF 다운로드</a>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  var reportData = /*[[${reportData}]]*/ [];
  var ctx = document.getElementById('stockChart').getContext('2d');
  var chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: reportData.map(item => item.itemName),
      datasets: [{
        label: '재고 가치',
        data: reportData.map(item => item.totalValue),
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: '가치 (원)'
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: '품목별 재고 가치'
        }
      }
    }
  });
  /*]]>*/
</script>
</body>
</html>