<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{include/layout/defaultLayout.html}">

<th:block layout:fragment="Content">
    <div>
        <!-- 상단 검색 -->
        <div class="p-3 mb-3 bxShadow saerchForm">
            <form th:action="@{/stock/list}" method="get">
                <div class="row">
                    <div class="searchFormInner mb-3">
                        <div>
                            <p>자재명</p>
                            <div class="input-group">
                                <input type="text" id="itemName" name="itemName" class="form-control">
                            </div>
                        </div>
                        <div>
                            <p>사용 상태</p>
                            <div class="input-group">
                                <select name="status" class="form-control">
                                    <option value="">선택</option>
                                    <option value="available">사용 가능</option>
                                    <option value="unavailable">사용 불가</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <p>최소 재고 수량</p>
                            <div class="input-group">
                                <input type="number" id="minQty" name="minQty" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="searchFormInner">
                        <div class="dateInput">
                            <p>입고 시작일</p>
                            <div class="input-group date">
                                <input type="text" class="form-control" id="startDate" name="startDate">
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="deliveryDateInput">
                            <p>입고 종료일</p>
                            <div class="input-group date">
                                <input type="text" class="form-control" id="endDate" name="endDate">
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <p>위치</p>
                            <div class="input-group">
                                <input type="text" id="loc" name="loc" class="form-control">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: auto;margin-right: .75rem;">검색</button>
                </div>
            </form>
        </div>

        <div class="p-3 mb-3 bxShadow">
            <table class="table">
                <thead class="thead-light">
                <tr>
                    <th>재고 ID</th>
                    <th>자재명</th>
                    <th>수량</th>
                    <th>상태</th>
                    <th>위치</th>
                    <th>재고 금액</th>
                    <th>입고 일자</th>
                    <th>유효 기간</th>
                    <th style="text-align: center;">액션</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="stock : ${stockList}">
                    <td th:text="${stock.stk_id}">재고 ID</td>
                    <td th:text="${stock.item_name}">자재명</td>
                    <td th:text="${stock.qty}">수량</td>
                    <td th:text="${stock.status}">상태</td>
                    <td th:text="${stock.loc}">위치</td>
                    <td th:text="${stock.value}">재고 금액</td>
                    <td th:text="${#dates.format(stock.in_date, 'yyyy-MM-dd')}">입고 일자</td>
                    <td th:text="${#dates.format(stock.exp_date, 'yyyy-MM-dd')}">유효 기간</td>
                    <td style="text-align: center;">
                        <!-- 상세 보기 버튼 -->
                        <a th:href="@{/stock/detail/{stkId}(stkId=${stock.stk_id})}" class="btn btn-outline-primary mr-2">상세</a>
                        <!-- 공급가 보기 버튼 -->
                        <a th:href="@{/stock/price/{stkId}(stkId=${stock.stk_id})}" class="btn btn-primary">공급가 확인</a>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- 재고 금액 산출 버튼 및 폼 -->
            <div class="tableBtn">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#stockValueModal">
                    재고 금액 계산
                </button>
            </div>
        </div>
    </div>

    <!-- Stock Value Modal -->
    <div class="modal newModal fade" id="stockValueModal" tabindex="-1" role="dialog" aria-labelledby="stockValueLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" style="width: 500px;">
                <div class="modal-header">
                    <h6 class="modal-title" id="stockValueLabel">재고 금액</h6>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 기간 입력 폼 -->
                    <form id="stockValueForm">
                        <div class="form-group modalStartDate">
                            <label for="modalStartDate">시작 날짜</label>
                            <div class="input-group date">
                                <input type="text" class="form-control" id="modalStartDate" name="modalStartDate" required>
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group modalEndDate">
                            <label for="modalEndDate">종료 날짜</label>
                            <div class="input-group date">
                                <input type="text" class="form-control" id="modalEndDate" name="modalEndDate" required>
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">계산</button>
                    </form>
                    <!-- 결과 표시 -->
                    <p class="mt-3">총 재고 금액: <span id="stockValue">0</span> 원</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</th:block>
</html>
<script th:src="@{/js/date.js}"></script>
<!-- JavaScript for AJAX and Modals -->
<script>
    // 재고 금액 모달을 위한 AJAX
    document.getElementById("stockValueForm").addEventListener("submit", function(event){
        event.preventDefault();

        const startDate = document.getElementById("modalStartDate").value;
        const endDate = document.getElementById("modalEndDate").value;

        fetch(`/stock/calculate-value?startDate=${startDate}&endDate=${endDate}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("stockValue").innerText = data.totalStockValue;
            })
            .catch(error => {
                document.getElementById("stockValue").innerText = 'Error retrieving value';
            });
    });
</script>